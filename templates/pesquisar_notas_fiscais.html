{% if session['privilegio'] == 1 or session['privilegio'] == 8 %}
    {% extends "base_recebimento.html" %}
{% elif session['privilegio'] == 2 %}
    {% extends "base_recebimento_concluido.html" %}
{% elif session['privilegio'] == 3 %}
    {% extends "base_zincagem.html" %}
{% elif session['privilegio'] == 4 %}
    {% extends "base_inspecao_final.html" %}
{% elif session['privilegio'] == 11 %}
    {% extends "base_faturamento.html" %}
{% elif session['privilegio'] == 12 %}
    {% extends "base_faturamento_lancamento.html" %}
{% elif session['privilegio'] == 99 %}
    {% extends "base_pesquisar.html" %}
{% else %}
    {% extends "base.html" %}
{% endif %}

{% block content %}

<!-- Inclua seu arquivo de estilos personalizados após o Bootstrap -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

<!-- Formulário de busca -->
<div class="py-3">
    <div class="container">
        <form method="GET" action="{{ url_for('pesquisar_notas_fiscais') }}">
            <div class="row">
                <div class="col-md-10">
                    <input type="text" class="form-control" name="search" placeholder="Buscar notas fiscais..." value="{{ search_query }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-secondary w-100">Buscar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Tabela para exibir as notas fiscais cadastradas -->
<div class="py-1">
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <h2 class="text-center">Notas Fiscais Cadastradas</h2>
                <div class="table-responsive">
                    {% for nota in notas_fiscais %}
                    <div class="card mb-2" style="border: 3px solid {% if nota.cad_lancamento|lower == 'ok' %}#28a745{% else %}#000{% endif %};">
                        <div class="card-body">
                            <!-- Primeira Linha -->
                            <div class="row">
                                <div class="col-md-3 text-left"><strong>Data Emissão NF:</strong> {{ nota.cad_data_emissao_nf.strftime('%d/%m/%Y') }}</div>
                                <div class="col-md-3 text-left"><strong>Número da Nota:</strong> {{ nota.cad_numero_nota }}</div>
                                <div class="col-md-3 text-left"><strong>Data Entrada ARS:</strong> {{ nota.cad_data_entrada_ars.strftime('%d/%m/%Y') }}</div>
                                <div class="col-md-3 text-left"><strong>Pedido:</strong> {{ nota.cad_pedido }}</div>
                            </div>
                            <!-- Segunda Linha -->
                            <div class="row">
                                <div class="col-md-3 text-left"><strong>Fornecedor:</strong> {{ nota.cad_fornecedor }}</div>
                                <div class="col-md-3 text-left"><strong>Volume:</strong> {{ nota.cad_volume }}</div>
                                <div class="col-md-3 text-left"><strong>Peso:</strong> {{ nota.cad_peso }}</div>
                                <div class="col-md-3 text-left"><strong>Natureza:</strong> {{ nota.cad_natureza }}</div>
                            </div>
                            <!-- Terceira Linha -->
                            <div class="row">
                                <div class="col-md-3 text-left"><strong>Certificado:</strong> {{ nota.cad_certificado }}</div>
                                <div class="col-md-6 text-left"><strong>Observação:</strong> {{ nota.cad_observacao }}</div>
                                <div class="col-md-3 text-left"><strong>Lançamento:</strong> {{ nota.cad_lancamento }}</div>
                            </div>
                            <!-- Quarta Linha -->
                            <div class="row">
                                <div class="col-md-12 text-left"><strong>Código XML:</strong> {{ nota.cad_cod_xml }}</div>
                            </div>
                            <!-- Botão de Download -->
                            <div class="row mt-3">
                                <div class="col-md-6 text-center">
                                    {% if nota.cad_arquivo_xml and nota.cad_arquivo_xml|length > 0 %}
                                    <a href="{{ url_for('download_xml', nota_id=nota.id) }}" class="btn btn-outline-primary w-100">
                                        <i class="fas fa-download"></i> Baixar XML
                                    </a>
                                    {% else %}
                                    <span class="text-muted">Nenhum arquivo</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 text-center">
                                    <button class="btn btn-outline-secondary w-100 openNfePortal" data-cod-xml="{{ nota.cad_cod_xml }}">
                                        <i class="fas fa-external-link-alt"></i> Abrir Portal NF-e
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Paginação -->
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        <!-- Link para a primeira página -->
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('pesquisar_notas_fiscais', page=1, search=search_query) }}">Primeira</a>
        </li>
        {% endif %}

        <!-- Link para a página anterior -->
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('pesquisar_notas_fiscais', page=page-1, search=search_query) }}">Anterior</a>
        </li>
        {% endif %}

        <!-- Páginas ao redor da página atual -->
        {% set start = max(1, page - 5) %}
        {% set end = min((total // per_page) + 1, page + 5) %}
        {% for p in range(start, end + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('pesquisar_notas_fiscais', page=p, search=search_query) }}">{{ p }}</a>
        </li>
        {% endfor %}

        <!-- Link para a próxima página -->
        {% if page < (total // per_page) + 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('pesquisar_notas_fiscais', page=page+1, search=search_query) }}">Próxima</a>
        </li>
        {% endif %}

        <!-- Link para a última página -->
        {% if page < (total // per_page) + 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('pesquisar_notas_fiscais', page=(total // per_page) + 1, search=search_query) }}">Última</a>
        </li>
        {% endif %}
    </ul>
</nav>

<script>
    // Código JavaScript para abrir o portal NF-e
    document.querySelectorAll('.openNfePortal').forEach(function(button) {
        button.addEventListener('click', function() {
            try {
                const url = 'https://www.nfe.fazenda.gov.br/portal/consultaRecaptcha.aspx?tipoConsulta=resumo&tipoConteudo=7PhJ+gAVw2g=';
                const newWindow = window.open(url, '_blank');
                if (!newWindow) {
                    console.error("Falha ao abrir a nova guia. Verifique se pop-ups estão bloqueados.");
                }
            } catch (error) {
                console.error("Erro ao tentar abrir a guia do NF-e:", error);
            }
        });
    });
</script>

{% endblock %}
