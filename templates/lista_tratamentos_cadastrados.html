{% if session['privilegio'] == 1 or session['privilegio'] == 8 %}
    {% extends "base_recebimento.html" %}
{% elif session['privilegio'] == 2 %}
    {% extends "base_recebimento_concluido.html" %}
{% elif session['privilegio'] == 3 %}
    {% extends "base_zincagem.html" %}
{% elif session['privilegio'] == 4 %}
    {% extends "base_inspecao_final.html" %}
{% elif session['privilegio'] == 11 %}
    {% extends "base_faturamento.html" %}
{% elif session['privilegio'] == 12 %}
    {% extends "base_faturamento_lancamento.html" %}
{% elif session['privilegio'] == 99 %}
    {% extends "base_pesquisar.html" %}
{% elif session['privilegio'] == 13 %}
    {% extends "base_faturamento_pesquisar_xml.html" %}
{% elif session['privilegio'] == 21 %}
    {% extends "base_compras.html" %}
{% elif session['privilegio'] == 31 %}
    {% extends "base_vendas2.html" %}
{% elif session['privilegio'] == 41 %}
    {% extends "base_loja.html" %}
{% elif session['privilegio'] == 51 %}
    {% extends "base_tratamentos.html" %}
{% elif session['privilegio'] == 59 %}
    {% extends "base_zincagem_inspecao.html" %}
{% else %}
    {% extends "base.html" %}
{% endif %}

{% block content %}

<style>
    .container-fluid {
        max-width: 100%;
        margin-left: 0;
        margin-right: 0;
    }
</style>

<div class="container-fluid">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mx-auto">Tratamentos Cadastrados</h1>
            <form method="POST" id="action_form" action="{{ url_for('alterar_estado_tratamento') }}">
                <button type="button" id="btn_enviar_selecionados" class="btn btn-primary">Marcar Selecionados como Enviado</button>
                <button type="button" id="btn_exportar_excel" class="btn btn-success">Exportar para Excel</button>
                <input type="hidden" name="ids_selecionados" id="ids_selecionados">
                <input type="hidden" name="nf_saida" id="nf_saida_hidden">
            </form>
        </div>
    </div>

    <!-- Exibir mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Tornar a tabela responsiva -->
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select_all"></th> <!-- Checkbox para selecionar todos -->
                    <th>Pedido Cliente</th>
                    <th>Código Produto</th>
                    <th>Descrição Produto</th>
                    <th>Quantidade</th>
                    <th>Rastreamento</th>
                    <th>Peso</th>
                    <th>Volume</th>
                    <th>Tipo Tratamento</th>
                    <th>Responsável</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody>
                {% for tratamento in tratamentos %}
                    <tr>
                        <td><input type="checkbox" class="checkbox_tratamento" value="{{ tratamento.id }}"></td>
                        <td>{{ tratamento.pedido_cliente }}</td>
                        <td>{{ tratamento.cod_produto }}</td>
                        <td>{{ tratamento.desc_produto }}</td>
                        <td>{{ tratamento.quantidade }}</td>
                        <td>{{ tratamento.rastreamento }}</td>
                        <td>{{ tratamento.peso }}</td>
                        <td>{{ tratamento.volume }}</td>
                        <td>{{ tratamento.tipo_tratamento }}</td>
                        <td>{{ tratamento.responsavel }}</td>
                        <td>{{ tratamento.data_cadastro.strftime('%d/%m/%Y') }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para confirmação de senha -->
<div class="modal fade" id="modalSenha" tabindex="-1" aria-labelledby="modalSenhaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSenhaLabel">Confirmação de Nota Fiscal de Saída</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p>Digite a Nota Fiscal de Saída para os tratamentos selecionados:</p>
                <div class="mb-3">
                    <label for="nf_saida" class="form-label">Nota Fiscal Saída:</label>
                    <input type="text" class="form-control" id="nf_saida" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmarEnvio">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Função para marcar como enviado
    document.getElementById('btn_enviar_selecionados').addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.checkbox_tratamento:checked');
        var idsSelecionados = [];
        checkboxes.forEach(function(checkbox) {
            idsSelecionados.push(checkbox.value);
        });

        if (idsSelecionados.length > 0) {
            document.getElementById('ids_selecionados').value = idsSelecionados.join(',');
            // Defina a ação do formulário para alterar o estado
            document.getElementById('action_form').action = "{{ url_for('alterar_estado_tratamento') }}";
            var modal = new bootstrap.Modal(document.getElementById('modalSenha'));
            modal.show();  // Abrir o modal para digitar a nf_saida
        } else {
            alert('Nenhum tratamento foi selecionado.');
        }
    });

    // Função para exportar para Excel
    document.getElementById('btn_exportar_excel').addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.checkbox_tratamento:checked');
        var idsSelecionados = [];
        checkboxes.forEach(function(checkbox) {
            idsSelecionados.push(checkbox.value);
        });

        if (idsSelecionados.length > 0) {
            document.getElementById('ids_selecionados').value = idsSelecionados.join(',');
            // Defina a ação do formulário para exportar o Excel
            document.getElementById('action_form').action = "{{ url_for('export_tratamentos_cadastrados_excel') }}";
            document.getElementById('action_form').submit();
        } else {
            alert('Nenhum tratamento foi selecionado para exportação.');
        }
    });

    // Confirmação da NF e envio do formulário para marcar como enviado
    document.getElementById('confirmarEnvio').addEventListener('click', function() {
        var nf_saida = document.getElementById('nf_saida').value;
        if (nf_saida) {
            document.getElementById('nf_saida_hidden').value = nf_saida;  // Passar nf_saida como hidden field
            // O formulário já estará com a ação correta configurada para "alterar_estado_tratamento"
            document.getElementById('action_form').submit();  // Submeter o formulário com IDs e nf_saida
        } else {
            alert('Por favor, insira a Nota Fiscal de Saída.');
        }
    });

    // Checkbox de selecionar todos
    document.getElementById('select_all').addEventListener('click', function() {
        var checkboxes = document.querySelectorAll('.checkbox_tratamento');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = this.checked;
        }.bind(this));
    });
</script>

{% endblock %}
